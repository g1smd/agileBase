##
##  Copyright 2013 GT webMarque Ltd
## 
##  This file is part of agileBase.
##
##  agileBase is free software: you can redistribute it and/or modify
##  it under the terms of the GNU General Public License as published by
##  the Free Software Foundation, either version 3 of the License, or
##  (at your option) any later version.
##  agileBase is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU General Public License for more details.
##
##  You should have received a copy of the GNU General Public License
##  along with agileBase.  If not, see <http://www.gnu.org/licenses/>.
##
$viewTools.startTimer("gui/reports_and_tables/tabs/view")
#set($rowCount = 0)

## view the data in the session table, plus related data
#set($tabCaption='view')
#set($viewOnly=true) ## $viewOnly used by resources/input/input.vm
#if(!$sessionTable)
  #set($sessionTable=$sessionData.getTable())
  #set($sessionReport=$sessionData.getReport())
#end
#if(!$sessionRowId)
  #set($sessionRowId=$sessionData.getRowId())
#end
#if($sessionRowId == -1)
	<div class="warningmessage">
		<b>No record selected:</b><p>
		Pick a record from above to view data or press the 'New' button to create a record
	</div>
#else
	#set($fieldsEncountered = {})
  #set($tablesEncountered = {})
  ## numTables used when arranging into columns
  #set($numTables = 0)
  #foreach($reportField in $sessionReport.getReportFields())
    #set($field = $reportField.getBaseField())
    #set($reportFieldTable = $field.getTableContainingField())
    #if($field.isPrimaryKey())
      #set($numTables = $numTables + 1)
    #end
  #end
  #if($numTables > 1)
    #set($colSplit = $numTables / 2)
    #set($remainder = $numTables % 2)
    #if($remainder != 0)
      #set($colSplit = $colSplit + 1)
    #end
    #set($colSplit = $colSplit + 1)
  #end
	<div class="reportDataView"><div id="leftcol" #if($numTables == 1) style="width: 100%" #end>
		## Show related data
		#foreach($reportField in $sessionReport.getReportFields())
		  ## don't show fields we've already shown
		  #set($field = $reportField.getBaseField())
		  #set($reportFieldTable = $field.getTableContainingField())
      ## if we have a relation to another table, show that table's data
      ## (if it has any related data)
      #if($field.isPrimaryKey())
        #set($success = $tablesEncountered.put($reportFieldTable, true))
        #if($tablesEncountered.size() == $colSplit)
          </div><div id="rightcol">
        #end
			  #if($reportFieldTable.equals($sessionTable))
			    #set($relatedRowIds = [])
			    #if(!$mobile_device) ## View and edit tabs are merged on mobile devices, don't display the session table data here
			      #set($success = $relatedRowIds.add($sessionRowId))
            #set($current = true)
            <div class="related" id="current">
			    #end
        #else
          #set($relatedRowIds = $view.getRelatedRowIds($sessionRowId, $reportFieldTable))
          #if($relatedRowIds.size() > 0)
            #set($related = true)
            <div class="related">
          #end
        #end
			  #set($numRelatedRows = $relatedRowIds.size())
			  #set($headingDisplayed = false)
			  #if ($numRelatedRows > 0)
	 	      ## attempt to only display related data if it's a managable amount
          #if(($numRelatedRows == 1) || (($numRelatedRows * ($reportFieldTable.getFields().size() - 1)) < 30))
		        #foreach($relatedRowId in $relatedRowIds)
		          #set($tableDataRow=$view.getTableDataRow($reportFieldTable, $relatedRowId))
		          #if ($tableDataRow.size() > 0)
				        #if(($numRelatedRows == 1) || (!$headingDisplayed))
					        #set($headingDisplayed = true)
                  <h1>$reportFieldTable.getSimpleName()</h1>
					      #end
                #set($rowCount = 0)
      			#set($address = $viewTools.getAddress($tableDataRow))
                #set($fields = $reportFieldTable.getFields())
                #foreach($field in $fields)
              	  #set($tableDataValue = $tableDataRow.get($field))
      					  #set($fieldCategory = $field.getFieldCategory())
									#set($comments = $view.getComments($field$, $relatedRowId))
									#set($hasComments = ($comments.size() > 0))
            		  ## don't display hidden or blank fields. Do display fields that may have comments
            		  #if($hasComments || (!$fieldCategory.savesData()) || (($field.getHidden() == false) && (($tableDataValue.toString() != '') || $printBlankFields) ))
                    ## don't display checkbox values that are false
                    #if(!(($tableDataValue.getClass().getSimpleName().equals("CheckboxValueDefn")) && ($tableDataValue.toString() == "false")))
                      #if($fieldCategory == "RELATION")
                        #set($fieldEncountered = $field.getDisplayField())
                      #else
                        #set($fieldEncountered = $field)
                      #end
                      #if((!$fieldsEncountered.containsKey($fieldEncountered)) && ($field.getPrintoutSetting().name() != "NO_PRINTOUT"))
                        #set($rrd_rowId = $relatedRowId) ## For use by input/referenced_report_data.vm
                        #parse("gui/reports_and_tables/tabs/table_data_row_view.vm")
                        #if($numRelatedRows == 1)
                          #set($success = $fieldsEncountered.put($fieldEncountered, true))
                        #end
                      #end
                    #end
                  #end
                #end ## end foreach field in table
      					## Display calculations if there are any in the current report
      					#if($reportFieldTable.equals($sessionTable))
              		#set($calculationReportFields = [])
              		#foreach($reportField in $sessionReport.getReportFields())
              		  #if($reportField.getClass().getSimpleName() == "ReportCalcFieldDefn")
              			#set($success = $calculationReportFields.add($reportField))
              		  #end
              		#end
              		#if($calculationReportFields.size() > 0)
              		  #set($reportFilter = $viewTools.getNewFilterMap())
              		  #set($success = $reportFilter.put($sessionTable.getPrimaryKey(),"$sessionRowId"))
    			          ## Note: limit to 1 row for now. There may be more than one row returned, deal with that later if necessary
              		  #set($reportDataRows = $view.getReportDataRows($sessionReport, 1, $reportFilter, true))
              			<div class="calculations">
              			  #foreach($reportDataRow in $reportDataRows)
              				#foreach($calcField in $calculationReportFields)
              				  <span class="greytext capitalised">$calcField: </span>
              				  $reportDataRow.getValue($calcField.getBaseField())<br>
              				#end
                      #end
                    </div>
              		#end ## End of calculations display
      					#end
		          #end ## end if ($tableDataRow.size() != 0)
		        #end ## end foreach related row id
          #else
            ## Too many records to display
		        #set($rowCount = $rowCount+1)
            There are $numRelatedRows related $reportFieldTable.getSimpleName() records
          #end ## end if number of related rows is a manageable amount
          #if($related || $current)
            </div>
            #set($related = false)
            #set($current = false)
          #end
        #else
          <div class="related">No $reportFieldTable.getSimpleName() attached</div>
        #end
      #end
		#end
  </div></div>
#end
$viewTools.stopTimer("gui/reports_and_tables/tabs/view")